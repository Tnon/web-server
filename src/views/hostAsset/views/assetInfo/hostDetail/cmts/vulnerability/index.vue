<template>
  <div class="contentp">
    <!-- 卡片筛选 start -->
    <detailAssetsFilter v-model:actived="othSta.actived" :id="id" />
    <!-- 卡片筛选 end -->
    <div class="tableTitle">
      <a-input-search
        :placeholder="othSta.placeHodler"
        class="search"
        @search="onSearch"
        @change="onSearch"
        v-model:value.trim="state.searchdata"
      />
    </div>
    <!-- 表格 start-->
    <div class="box">
      <slots-table
        :scroll="{ y: 'calc(100vh - 479px)' }"
        ref="tableRef"
        v-model:columns="columnsData"
        row-key="vul_id"
        :get-list-func="othSta.api"
        class="hostDetailTable"
        :arguments="state"
      >
        <!--  自定义slots start-->
        <template #bodyCellcustom="{ record, column }">
          <template v-if="column.dataIndex === 'detail'">
            <span @click="showDrawer(record)" class="num_color">{{ t('asset.lookOver') }}</span>
          </template>
        </template>
        <!--    自定义slots end-->
      </slots-table>
    </div>
    <!-- 表格 end-->
  </div>
</template>

<script lang="ts" setup>
  import { reactive, watch, ref, computed } from 'vue';
  import detailAssetsFilter from './cmts/detailAssetsFilter';
  import { SlotsTable } from '@/components/slots-table';
  import { Ftypes } from './type';
  import { useI18n } from 'vue-i18n';
  import { getapi_columnsDetail } from '@/views/hostAsset/views/assetRisk/detail/detailCol';
  import { useUserToken } from '@/store/modules/user';
  import detailApi from '@/api/asset/assetRisk';
  import { vulType } from '@/enums/assetsType';
  import { Language } from '@/enums/language';
  import useCreatDraw from '@/hooks/use-click-row';
  import draw from '@/views/hostAsset/views/assetRisk/draw';
  const props = defineProps({
    id: String,
  });
  const { t } = useI18n();
  // 当前系统语言
  const userTokenStore = useUserToken();
  const currentLang = computed(() => userTokenStore.userLanguage);
  const columnsData = getapi_columnsDetail('Ip', t, currentLang.value);
  const tableRef = ref<any>();
  const state = reactive({
    host_id: props.id!,
    searchdata: '',
    vul_category: 0, //待调试
  });
  const othSta = reactive<any>({
    actived: 'overview',
    placeHodler: t('asset.pInput', [t(`asset.vultyNameOrAccount`)]),
    api: detailApi[`api_overview`]['getHostViewDetail'],
  });
  //切换表头
  watch(
    () => othSta.actived,
    (v: Ftypes) => {
      othSta.api = detailApi[`api_${v}`]['getHostViewDetail'];
      state.vul_category = vulType[v];
    },
  );
  // 搜索框变化刷新表格
  const onSearch = (v, e) => {
    const { value } = v.target ?? { value: v };
    if (e && value) {
      tableRef.value.refreshTableData();
    }
    if (!value && !e) {
      tableRef.value.refreshTableData();
    }
  };

  // 详情抽屉
  const showDrawer = (record) => {
    useCreatDraw(
      {
        // 英文模式下不显示漏洞名称
        title: currentLang.value === Language.EN ? '' : record.title!,
        contentProps: {
          record,
          host_id: props.id,
        },
      },
      draw,
    );
  };
</script>

<style lang="less" scoped>
  .contentp {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .box {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
  }
  .search {
    width: 220px;
    margin-right: 16px;
  }

  .tableTitle {
    padding: 8px;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
  }
  .num_color {
    color: #18ba79;
    cursor: pointer;
  }
</style>
